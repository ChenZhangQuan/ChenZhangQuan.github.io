<!DOCTYPE html><html lang="Javascript"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS逆向开发流程-砸壳 · SillyGe's blog</title><meta name="description" content="iOS逆向开发流程-砸壳 - SillyGe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/avatar.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="SillyGe's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/avatar.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/2161127852?refer_flag=1001030102_&amp;is_all=1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ChenZhangQuan" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS逆向开发流程-砸壳</h1><div class="post-info">Dec 7, 2017</div><div class="post-content"><p><a href="http://www.jianshu.com/p/189afbe3b429" target="_blank" rel="external">http://www.jianshu.com/p/189afbe3b429</a><br><a href="http://www.jianshu.com/p/4da57be23275" target="_blank" rel="external">http://www.jianshu.com/p/4da57be23275</a></p>
<h2 id="一-连接上越狱手机"><a href="#一-连接上越狱手机" class="headerlink" title="一.连接上越狱手机"></a>一.连接上越狱手机</h2><p>1.准备一台越狱的机子。<br>2.电脑手机连在同个wifi下。<br>3.越狱的机子上进Cydia下载 OPENSSH (有时候装不起来是因为cydia需要更新新东西，cydia会弹更新窗，更新必要组件后下载就可以安装成功了)<br>4.在terminal中敲 ssh root@192.168.x.x  后面是手机在的ip地址<br>5.输入密码，默认密码为:alpine<br>  chenzhangquandeMacBook-Pro:~ chenzhangquan$ ssh root@192.168.0.107<br>  The authenticity of host ‘192.168.0.107 (192.168.0.107)’ can’t be established.<br>  RSA key fingerprint is SHA256:LL3oni3/5ADyPHB7lM9K/ZoCdBoqNEYqdllzlkvwkhw.<br>  Are you sure you want to continue connecting (yes/no)? yes<br>  Warning: Permanently added ‘192.168.0.107’ (RSA) to the list of known hosts.<br>  root@192.168.0.107’s password:<br>  iPhone4:~ root# ls<br>  至此就进入越狱的手机了。</p>
<h2 id="二-找出反编译APP的Documents目录路径"><a href="#二-找出反编译APP的Documents目录路径" class="headerlink" title="二.找出反编译APP的Documents目录路径"></a>二.找出反编译APP的Documents目录路径</h2><p>1.把其他app都退出，只留目标app。<br>2.在终端上敲 ps -e，会出现<br>  iPhone4:~ root# ps -e<br>      PID TTY           TIME CMD<br>      3964 ??         0:00.07 /usr/libexec/afc2d -S -L -d /<br>      3969 ??         0:00.36 /usr/libexec/springboardservicesrelay<br>      4132 ??         1:23.41 /var/mobile/Applications/F1BE7862-F90D-4D8E-B600-2BF786FFA5CC/Wsloan_40.app<br>      4137 ??         0:01.83 /usr/libexec/pphelper/PPHelperLaunchd<br>      4161 ??         0:00.26 /System/Library/PrivateFrameworks/TouchRemote.framework/Support/touchsetupd<br>      4163 ??         0:01.37 /usr/libexec/securityd<br>Wsloan_40就是我的目标app</p>
<p>3.越狱的机子上进Cydia下载Cycript<br>4.在终端中输入作以下操作:<br>  iPhone4:~ root# cycript -p Wsloan_40<br>  cy# [[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomans:NSUserDomainMask][0]</p>
<p>  #”file:///var/mobile/Applications/F1BE7862-F90D-4D8E-B600-2BF786FFA5CC/Documents/“</p>
<p>  其中的 /var/mobile/Applications/F1BE7862-F90D-4D8E-B600-2BF786FFA5CC/Documents/ 就是我们要找的Documents目录路径</p>
<h2 id="三-砸壳"><a href="#三-砸壳" class="headerlink" title="三.砸壳"></a>三.砸壳</h2><p>1.<a href="https://github.com/stefanesser/dumpdecrypted" target="_blank" rel="external">https://github.com/stefanesser/dumpdecrypted</a> 下载dumpdecrypted<br>2.进入dumpdecrypted文件夹 执行makechenzhangquandeMacBook-Pro:dumpdecrypted-master chenzhangquan$ make<br>  <code>xcrun --sdk iphoneos --find gcc</code> -Os  -Wimplicit -isysroot <code>xcrun --sdk iphoneos --show-sdk-path</code> -F<code>xcrun --sdk iphoneos --show-sdk-path</code>/System/Library/Frameworks -F<code>xcrun --sdk iphoneos --show-sdk-path</code>/System/Library/PrivateFrameworks -arch armv7 -arch armv7s -arch arm64 -c -o dumpdecrypted.o dumpdecrypted.c<br>  xcrun: error: SDK “iphoneos” cannot be located<br>  xcrun: error: SDK “iphoneos” cannot be located<br>  xcrun: error: SDK “iphoneos” cannot be located<br>  xcrun: error: unable to lookup item ‘Path’ in SDK ‘iphoneos’<br>  xcrun: error: SDK “iphoneos” cannot be located<br>  xcrun: error: SDK “iphoneos” cannot be located<br>  xcrun: error: unable to lookup item ‘Path’ in SDK ‘iphoneos’<br>  xcrun: error: SDK “iphoneos” cannot be located<br>  xcrun: error: SDK “iphoneos” cannot be located<br>  xcrun: error: unable to lookup item ‘Path’ in SDK ‘iphoneos’<br>  clang: warning: no such sysroot directory: ‘-F/System/Library/Frameworks’ [-Wmissing-sysroot]<br>  clang: warning: no such sysroot directory: ‘-F/System/Library/Frameworks’ [-Wmissing-sysroot]<br>  clang: warning: no such sysroot directory: ‘-F/System/Library/Frameworks’ [-Wmissing-sysroot]<br>  dumpdecrypted.c:27:10: fatal error: ‘stdio.h’ file not found</p>
<p>  #include <stdio.h><br>           ^<br>  1 error generated.<br>  make: <em>*</em> [dumpdecrypted.o] Error 1<br>  报错，终端执行 sudo xcode-select –switch /Applications/Xcode8.0.app/后，在执行make，编译成功<br>至此编译成功砸壳工具dumpdecrypted.dylib</stdio.h></p>
<p>3.将dumpdecrypted.dylib拷贝到Documents目录下，此处是使用scp方式，也可以使用iFunBox或者PP助手进行文件操作</p>
<p>chenzhangquandeMacBook-Pro:dumpdecrypted-master chenzhangquan$ scp /Users/chenzhangquan/Desktop/iOS逆向开发/dumpdecrypted-master/dumpdecrypted.dylib root@192.168.0.107:/var/mobile/Applications/F1BE7862-F90D-4D8E-B600-2BF786FFA5CC/Documents/<br>root@192.168.0.107’s password:<br>dumpdecrypted.dylib                           100%  193KB   1.3MB/s   00:00</p>
<p>4.开始砸壳 dumpdecrypted.dylib的具体用法是：DYLD_INSERT_LIBRARIES=/PathFrom/dumpdecrypted.dylib /PathTo</p>
<p>4.1 cd到/var/mobile/Applications/F1BE7862-F90D-4D8E-B600-2BF786FFA5CC/Documents后</p>
<p>4.2 执行  DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib /var/mobile/Applications/F1BE7862-F90D-4D8E-B600-2BF786FFA5CC/Wsloan_40.app/Wsloan_40 (此处要添加/Wsloan_40) 如下:</p>
<p>  iPhone4:/var/mobile/Applications/F1BE7862-F90D-4D8E-B600-2BF786FFA5CC/Documents root# DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib /var/mobile/Applications/F1BE7862-F90D-4D8E-B600-2BF786FFA5CC/Wsloan_40.app/Wsloan_40<br>  mach-o decryption dumper</p>
<p>  DISCLAIMER: This tool is only meant for security research purposes, not for application crackers.</p>
<p>  [+] detected 32bit ARM binary in memory.<br>  [+] offset to cryptid found: @0xdcad4(from 0xdc000) = ad4<br>  [+] Found encrypted data at address 00004000 of length 14532608 bytes - type 1.<br>  [+] Opening /private/var/mobile/Applications/F1BE7862-F90D-4D8E-B600-2BF786FFA5CC/Wsloan_40.app/Wsloan_40 for reading.<br>  [+] Reading header<br>  [+] Detecting header type<br>  [+] Executable is a FAT image - searching for right architecture<br>  [+] Correct arch is at offset 16384 in the file<br>  [+] Opening Wsloan_40.decrypted for writing.<br>  [+] Copying the not encrypted start of the file<br>  [+] Dumping the decrypted data into the file<br>  [+] Copying the not encrypted remainder of the file<br>  [+] Setting the LC_ENCRYPTION_INFO-&gt;cryptid to 0 at offset 4ad4<br>  [+] Closing original file<br>  [+] Closing dump file</p>
<p>至此发现Documents文件夹下多了一个Wsloan_40.decrypted<br>4.3 还是用scp把这个东西传回mac<br>在本地mac上执行 scp root@192.168.0.107:/var/mobile/Applications/F1BE7862-F90D-4D8E-B600-2BF786FFA5CC/Documents/Wsloan_40.decrypted /Users/chenzhangquan/Desktop/iOS逆向开发/</p>
<h2 id="四-导出头文"><a href="#四-导出头文" class="headerlink" title="四.导出头文"></a>四.导出头文</h2><p>从Github上下载最新的class-dump源代码，然后用Xcode编译即可生成class-dump(这里比较简单，笔者就不详细说明了)。</p>
<p>1.导ipa ./class-dump -H /Users/chenzhangquan/Desktop/Wsloan_40\ 2017-12-04\ 14-18-39/Payload/Wsloan_40.app -o /Users/chenzhangquan/Desktop/dddd<br>2.导decrypted ./class-dump –arch armv7 Wsloan_40.decrypted &gt; Wsloan_40.m<br>注意不同型号说记对应的内核4（armv7），4s（armv7），5（armv7），5s，iPad air（arm64），6（arm64），6s（arm64）<br>  （或者执行./class-dump -H –arch armv7 Wsloan_40.decrypted -o /Users/chenzhangquan/Desktop/iOS逆向开发/wsloan/dump  可以导出到一个文件夹内。）<br>至此导出了Wsloan_40.m文件。（或.h文件夹）</p>
<p>scp root@192.168.0.106:/var/mobile/Library/Keyboard/dynamic-text.dat /Users/chenzhangquan/Desktop/iOS逆向开发/</p>
<h2 id="五-导出头文（直接能拿到ipa的话）"><a href="#五-导出头文（直接能拿到ipa的话）" class="headerlink" title="五.导出头文（直接能拿到ipa的话）"></a>五.导出头文（直接能拿到ipa的话）</h2><p>class-dump -H 要破解的可执行文件路径 -o 破解后的头文件存放路径</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/12/08/iOS逆向开发流程-gdb调试/" class="prev">上一篇</a><a href="/2017/12/04/wsloan推送测试流程/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">SillyGe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>