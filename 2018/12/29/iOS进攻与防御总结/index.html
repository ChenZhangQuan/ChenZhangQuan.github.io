<!DOCTYPE html><html lang="Javascript"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS进攻与防御总结 · SillyGe's blog</title><meta name="description" content="iOS进攻与防御总结 - SillyGe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/avatar.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="SillyGe's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/avatar.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/2161127852?refer_flag=1001030102_&amp;is_all=1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ChenZhangQuan" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS进攻与防御总结</h1><div class="post-info">Dec 29, 2018</div><div class="post-content"><h2 id="防守。"><a href="#防守。" class="headerlink" title="防守。"></a>防守。</h2><h3 id="1-重签名防护"><a href="#1-重签名防护" class="headerlink" title="1.重签名防护"></a>1.重签名防护</h3><h4 id="思路-比较工程目录下-embedded-mobileprovision-文件中的application-identifier的bundle进行比对。"><a href="#思路-比较工程目录下-embedded-mobileprovision-文件中的application-identifier的bundle进行比对。" class="headerlink" title="思路:比较工程目录下 embedded.mobileprovision 文件中的application-identifier的bundle进行比对。"></a>思路:比较工程目录下 embedded.mobileprovision 文件中的application-identifier的bundle进行比对。</h4><h5 id="破解方式"><a href="#破解方式" class="headerlink" title="破解方式"></a>破解方式</h5><p>hook重签名防护代码</p>
<h3 id="2-反调试"><a href="#2-反调试" class="headerlink" title="2.反调试"></a>2.反调试</h3><h4 id="思路-通过ptrace反调试。"><a href="#思路-通过ptrace反调试。" class="headerlink" title="思路:通过ptrace反调试。"></a>思路:通过ptrace反调试。</h4><h5 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式:"></a>实现方式:</h5><p>复制macOS下的头文件，再调用</p>
<blockquote>
<pre><code>ptrace(PT_DENY_ATTACH,0,0,0);
</code></pre><h5 id="破解方式-1"><a href="#破解方式-1" class="headerlink" title="破解方式"></a>破解方式</h5><p>hook系统的ptrace代码</p>
<h5 id="防护升级"><a href="#防护升级" class="headerlink" title="防护升级"></a>防护升级</h5><p>通过framework提前ptrace执行时序，你就直接闪退了，无法fishHook系统函数</p>
<h5 id="破解升级"><a href="#破解升级" class="headerlink" title="破解升级"></a>破解升级</h5><p>通过下符号断点去查找ptrace，或者exit的汇编代码，修改ptrace汇编代码逻辑，破坏反调试。（跟反反hook一样，通过修改汇编代码破坏ptrace或者exit的调用代码）</p>
<h5 id="防护继续升级"><a href="#防护继续升级" class="headerlink" title="防护继续升级"></a>防护继续升级</h5><p>通过svc让你找不到ptrace和exit。</p>
</blockquote>
<h3 id="3-反hook"><a href="#3-反hook" class="headerlink" title="3.反hook"></a>3.反hook</h3><h4 id="思路-通过framework提前fishhook反hook代码"><a href="#思路-通过framework提前fishhook反hook代码" class="headerlink" title="思路:通过framework提前fishhook反hook代码"></a>思路:通过framework提前fishhook反hook代码</h4><h5 id="破解方式-2"><a href="#破解方式-2" class="headerlink" title="破解方式"></a>破解方式</h5><p>通过下符号断点去查找method_setImplimentation,通过汇编破坏反hook函数。</p>
<h3 id="4-反注入"><a href="#4-反注入" class="headerlink" title="4.反注入"></a>4.反注入</h3><h4 id="思路-修改DYLD-INSERT-LIBRARIES来防止动态注入"><a href="#思路-修改DYLD-INSERT-LIBRARIES来防止动态注入" class="headerlink" title="思路:修改DYLD_INSERT_LIBRARIES来防止动态注入"></a>思路:修改DYLD_INSERT_LIBRARIES来防止动态注入</h4><h5 id="实现方式-1"><a href="#实现方式-1" class="headerlink" title="实现方式:"></a>实现方式:</h5><p>  在工程中的build setting里的 other linker flag字段为</p>
<blockquote>
<p>  -Wl,-sectcreate,<strong>RESTRICT,</strong>restrict,/dev/null</p>
<h5 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h5><p>可以防止动态注入tweak生成的动态库插件，可以防止动态砸壳</p>
<h6 id="ps-在模拟器会造成无法调试的问题。dyld-dyld-sim-cannot-be-loaded-in-a-restricted-process"><a href="#ps-在模拟器会造成无法调试的问题。dyld-dyld-sim-cannot-be-loaded-in-a-restricted-process" class="headerlink" title="ps:在模拟器会造成无法调试的问题。dyld: dyld_sim cannot be loaded in a restricted process"></a>ps:在模拟器会造成无法调试的问题。dyld: dyld_sim cannot be loaded in a restricted process</h6></blockquote>
<h5 id="破解方式-3"><a href="#破解方式-3" class="headerlink" title="破解方式"></a>破解方式</h5><p>通过修改二进制文件去更改restrict字段。</p>
<h5 id="防护升级-1"><a href="#防护升级-1" class="headerlink" title="防护升级"></a>防护升级</h5><p>通过代码查看dyld源码查看restrict字段是否被改变</p>
<h5 id="黑客最终手段"><a href="#黑客最终手段" class="headerlink" title="黑客最终手段"></a>黑客最终手段</h5><p>hook升级防护代码</p>
<h2 id="简便的代码防护手段。"><a href="#简便的代码防护手段。" class="headerlink" title="简便的代码防护手段。"></a>简便的代码防护手段。</h2><p>1.使用宏定义进行代码混淆<br>2.对核字符串key进行c函数异或隐藏。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/12/27/iOS逆向开发流程-砸壳-Clutch/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yoursite.com">SillyGe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>